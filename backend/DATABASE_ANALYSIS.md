# MongoDB Database Analysis

## Connection Information
- **Connection String**: `mongodb+srv://exot4396_db_user:0TaaaCjkHELW6paY@cluster0.ni3wr96.mongodb.net/?appName=Cluster0`
- **Cluster**: `cluster0.ni3wr96.mongodb.net`
- **Expected Database Name**: `knowdb` (default if not specified in connection string)

## Expected Collections

Based on the application codebase, the following collections are expected:

### 1. `querylogs` (QueryLog Model)

**Purpose**: Stores query history and execution logs

**Schema Structure**:
```typescript
{
  conversationId: string,      // Required, indexed
  userId?: string,             // Optional, indexed
  userQuery: string,           // Required - the user's natural language query
  generatedQuery: string,      // Required - the generated MongoDB query
  result: unknown,             // Mixed type - query execution results
  executionTime?: number,      // Optional - query execution time in ms
  error?: string,              // Optional - error message if query failed
  timestamp: Date,             // Auto-generated, indexed, default: Date.now
  createdAt: Date,             // Auto-generated by Mongoose
  updatedAt: Date              // Auto-generated by Mongoose
}
```

**Indexes**:
- `conversationId` (indexed)
- `userId` (indexed)
- `timestamp` (indexed)

**Usage**: 
- Created by `HistoryService.saveQuery()`
- Retrieved by `HistoryService.getHistory()`
- Used for conversation history tracking

### 2. `schemametas` (SchemaMeta Model)

**Purpose**: Stores cached database schema metadata

**Schema Structure**:
```typescript
{
  schema: DatabaseSchema,       // Required, Mixed type
  lastUpdated: Date,            // Default: Date.now
  version: number,              // Default: 1, auto-incremented
  createdAt: Date,             // Auto-generated by Mongoose
  updatedAt: Date              // Auto-generated by Mongoose
}
```

**DatabaseSchema Structure**:
```typescript
{
  collections: SchemaCollection[]
}

SchemaCollection {
  name: string,
  fields: SchemaField[]
}

SchemaField {
  name: string,
  type: string,
  required?: boolean,
  default?: unknown
}
```

**Indexes**:
- `_id` (unique index)

**Usage**:
- Cached schema information parsed from the database
- Updated by `SchemaService.saveSchemaToDB()`
- Retrieved by `SchemaService.loadSchemaFromDB()`
- Cache TTL: 5 minutes

## Database Operations

### Query Execution
The application executes MongoDB queries through `DBService.executeQuery()`:
- Supports: `find()`, `findOne()`, `aggregate()`, `countDocuments()`
- Safety: Blocks dangerous operations (dropDatabase, dropCollection, remove, deleteMany, drop, shutdown)
- Result limit: 100 documents per query
- Max result size: Defined in `MAX_RESULT_SIZE` constant

### Schema Parsing
The application automatically parses database schema:
- Skips system collections (starting with `system.`)
- Analyzes sample documents to infer field types
- Handles nested objects and arrays
- Caches schema for 5 minutes

## Connection Configuration

The application uses the following connection options:
- `serverSelectionTimeoutMS`: 30000 (30 seconds)
- `socketTimeoutMS`: 45000 (45 seconds)
- `connectTimeoutMS`: 30000 (30 seconds)
- `maxPoolSize`: 10
- `minPoolSize`: 1
- `retryWrites`: true
- `retryReads`: true
- `heartbeatFrequencyMS`: 10000 (10 seconds)

## Troubleshooting Connection Issues

If you're experiencing SSL/TLS connection errors:

1. **IP Whitelist**: Ensure your IP address is whitelisted in MongoDB Atlas
   - Go to MongoDB Atlas â†’ Network Access
   - Add your current IP address or use `0.0.0.0/0` for development (not recommended for production)

2. **Database Name**: The connection string might need an explicit database name
   - Current: `mongodb+srv://...@cluster0.ni3wr96.mongodb.net/?appName=Cluster0`
   - With DB: `mongodb+srv://...@cluster0.ni3wr96.mongodb.net/knowdb?appName=Cluster0`

3. **Authentication**: Verify the username and password are correct
   - Username: `exot4396_db_user`
   - Password: `0TaaaCjkHELW6paY`

4. **MCP Server**: Since you've configured an MCP server, you can use it to query the database directly
   - The MCP server is configured in `.cursor/.mcp.json`
   - It's set to read-only mode (`--readOnly`)

## Using the MCP Server

The MongoDB MCP server is configured and can be used to:
- List databases
- List collections
- Query documents (read-only)
- Analyze schema

To use it, you can interact with the MCP server through Cursor's MCP integration.

## Next Steps

1. **Verify Collections**: Check if `querylogs` and `schemametas` collections exist
2. **Check Data**: Verify if there's any existing data in these collections
3. **Schema Analysis**: Run schema parsing to see what other collections exist in your database
4. **Index Optimization**: Review indexes on collections for performance

## Analysis Scripts

Two analysis scripts have been created:
- `scripts/analyze-db.ts` - Uses native MongoDB driver
- `scripts/analyze-db-mongoose.ts` - Uses Mongoose (same as application)

Both scripts will:
- List all databases
- List all collections in each database
- Show document counts
- Display indexes
- Show sample documents
- Analyze field types
- Check for application-specific collections

**Note**: These scripts require IP whitelisting in MongoDB Atlas to work.

